@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Map Test";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin="" />

<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

<script src="~/lib/microsoft-signalr/signalr.js"></script>

<style>
    #map {
        height: 500px;
    }
</style>


<div>
    <div class="col-lg-8 offset-lg-2 col-md-8 offset-md-2 col-sm-8 offset-sm-2 mainMap" id="map"></div>
</div>


<script type="text/javascript">


    var connection = new signalR.HubConnectionBuilder().withUrl("/MySignalRTest").build();
    connection.start().then(function() {
            console.log("Signalr conected");
        }).catch(function(err) {
            return console.error(err.toString());
        });


    var currentLat = 35.78023853564178;
    var currentLng = 51.46740881600891;
    var firstTime = true;
    var secondTime = true;
    var firstlatlng = {};
    var secondlatlng = {};
    var markerArray = new Array();


        var map = L.map('map', {
        center: [currentLat, currentLng],
        minZoom: 10,
        maxZoom: 18,
        zoom: 17
    });

    var tile = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: '&copy;جون به این مملکت' }).addTo(map);

    var circle = L.circle([currentLat, currentLng], {
        fillOpacity: 0.1,
        radius: 15
    }).addTo(map);


    var popup = L.popup();

    var myIcon = L.Icon.extend({
        options: {
            iconSize: [40, 40]
        }
    });

    var firstIcon = new myIcon({ iconUrl: '/img/mapFirst.ico' });
    var secondIcon = new myIcon({ iconUrl: '/img/mapSecond.ico' });

    function onMapClick(e) {
            popup
            .setLatLng(e.latlng)
            .setContent('You clicked the map at ' + e.latlng.toString())
            .openOn(map);
            setMarker(e.latlng);
    }

    function setMarker(latlng) {
        if (firstTime == true) {
            firstlatlng = latlng;
            marker = L.marker([latlng.lat, latlng.lng], { icon: firstIcon, title: "مبدا" });
            firstTime = false;
        }
        else {
            secondlatlng = latlng;
            if (secondTime == false) {
                var remove = markerArray.pop();
                map.removeLayer(remove);
            }
            marker = L.marker([latlng.lat, latlng.lng], { icon: secondIcon, title: "مقصد" });
            secondTime = false;
        }
        map.addLayer(marker);
        markerArray.push(marker);
    }

    map.on('click', onMapClick);

    function clearLastMarker() {

        if (markerArray.length <= 0)
            return;

        var remove = markerArray.pop();
        map.removeLayer(remove);

        if (secondTime == false) {
            secondTime = true;
            secondlatlng = {};
        }
        else {
            firstTime = true;
            firstlatlng = {};
        }
    }

    function clearMarkers() {
        while (markerArray.length > 0) {
            var remove = markerArray.pop();
            map.removeLayer(remove);
        }

        firstTime = true;
        secondTime = true;
        firstlatlng = {};
        secondlatlng = {};
    }

</script>
